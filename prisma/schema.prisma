generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  MEMBER
  ADMIN
  VISITOR
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  WAITLISTED
}

enum CohortStatus {
  ACTIVE
  FALLOW
  UPCOMING
}

enum EventType {
  KICKOFF
  DATE_NIGHT
  GALA
  WORKSHOP
  SOCIAL
  WELLNESS
  CULTURAL
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum RelationshipStyle {
  MONOGAMOUS
  OPEN
  POLYAMOROUS
  EXPLORING
  PREFER_NOT_TO_SAY
}

enum LookingFor {
  RELATIONSHIP
  FRIENDS
  DATING
  HOOKUPS
  NETWORKING
  OPEN_TO_ALL
}

model User {
  id                String            @id @default(uuid())
  email             String            @unique
  password          String?
  name              String
  displayName       String?
  age               Int?
  dateOfBirth       DateTime?
  role              Role              @default(MEMBER)
  applicationStatus ApplicationStatus @default(PENDING)
  
  // Profile fields
  bio               String?           @db.Text
  headline          String?
  height            String?
  bodyType          String?
  ethnicity         String?
  pronouns          String?
  hivStatus         String?
  relationshipStyle RelationshipStyle?
  lookingFor        LookingFor[]      @default([])
  interests         String[]          @default([])
  sexPositions      String[]          @default([])
  kinks             String[]          @default([])
  
  // Location
  latitude          Float?
  longitude         Float?
  locationName      String?
  lastLocationUpdate DateTime?
  
  // Media
  profilePhotos     Media[]           @relation("UserPhotos")
  avatarUrl         String?
  
  // Cohort & Membership
  cohort            Cohort?           @relation(fields: [cohortId], references: [id])
  cohortId          String?
  memberSince       DateTime?
  isVisitor         Boolean           @default(false)
  visitorPassExpiry DateTime?
  lastActive        DateTime?
  
  // Preferences
  ageRangeMin       Int               @default(18)
  ageRangeMax       Int               @default(99)
  maxDistance       Int               @default(50)
  
  // Endorsements & Trust
  endorsements      Endorsement[]     @relation("UserEndorsements")
  givenEndorsements Endorsement[]     @relation("EndorserEndorsements")
  
  // Social
  sentMessages      Message[]         @relation("SentMessages")
  receivedMessages  Message[]         @relation("ReceivedMessages")
  conversations     ConversationParticipant[]
  eventRsvps        EventRsvp[]
  reports           Report[]          @relation("ReportedBy")
  reportedReports   Report[]          @relation("ReportedUser")
  blockedUsers      Block[]           @relation("Blocker")
  blockedByUsers    Block[]           @relation("Blocked")
  likes             Like[]            @relation("LikedBy")
  likedBy           Like[]            @relation("LikedUser")
  
  // Verification
  isVerified        Boolean           @default(false)
  verifiedAt        DateTime?
  
  // Application fields
  applicationNote   String?           @db.Text
  referredBy        String?
  
  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // OAuth
  accounts          Account[]
  sessions          Session[]
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Media {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation("UserPhotos", fields: [userId], references: [id], onDelete: Cascade)
  url         String
  thumbnailUrl String?
  type        String   @default("image") // image, video
  isPrivate   Boolean  @default(false)
  isPrimary   Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
}

model Cohort {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  startDate   DateTime
  endDate     DateTime
  status      CohortStatus @default(UPCOMING)
  isActive    Boolean      @default(false)
  maxMembers  Int          @default(500)
  members     User[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model TimeWindow {
  id           String  @id @default(uuid())
  dayOfWeek    Int     @default(4) // Thursday
  startHour    Int     @default(16) // 4pm
  endDayOfWeek Int     @default(5) // Friday
  endHour      Int     @default(24) // Midnight
  isActive     Boolean @default(true)
}

model Conversation {
  id           String                    @id @default(uuid())
  participants ConversationParticipant[]
  messages     Message[]
  lastMessage  DateTime?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastReadAt     DateTime?
  isTyping       Boolean      @default(false)
  typingAt       DateTime?
  createdAt      DateTime     @default(now())

  @@unique([conversationId, userId])
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User          @relation("SentMessages", fields: [senderId], references: [id])
  receiverId     String
  receiver       User          @relation("ReceivedMessages", fields: [receiverId], references: [id])
  content        String        @db.Text
  mediaUrl       String?
  mediaType      String?       // image, video, audio
  status         MessageStatus @default(SENT)
  deliveredAt    DateTime?
  readAt         DateTime?
  createdAt      DateTime      @default(now())
}

model Event {
  id          String      @id @default(uuid())
  title       String
  description String?     @db.Text
  eventType   EventType
  eventDate   DateTime
  endDate     DateTime?
  location    String?
  address     String?
  latitude    Float?
  longitude   Float?
  imageUrl    String?
  maxCapacity Int?
  price       Float       @default(0)
  isPublic    Boolean     @default(true)
  rsvps       EventRsvp[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model EventRsvp {
  id        String   @id @default(uuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String   @default("going") // going, maybe, not_going
  createdAt DateTime @default(now())

  @@unique([eventId, userId])
}

model Endorsement {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation("UserEndorsements", fields: [userId], references: [id], onDelete: Cascade)
  endorserId  String
  endorser    User     @relation("EndorserEndorsements", fields: [endorserId], references: [id])
  message     String?  @db.Text
  isVerified  Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@unique([userId, endorserId])
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation("LikedBy", fields: [userId], references: [id], onDelete: Cascade)
  likedId   String
  liked     User     @relation("LikedUser", fields: [likedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, likedId])
}

model Block {
  id        String   @id @default(uuid())
  blockerId String
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blockedId String
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([blockerId, blockedId])
}

model Report {
  id          String   @id @default(uuid())
  reporterId  String
  reporter    User     @relation("ReportedBy", fields: [reporterId], references: [id])
  reportedId  String
  reported    User     @relation("ReportedUser", fields: [reportedId], references: [id])
  reason      String
  description String?  @db.Text
  status      String   @default("pending") // pending, reviewed, resolved
  createdAt   DateTime @default(now())
}

model VisitorPass {
  id           String   @id @default(uuid())
  email        String
  name         String
  price        Float    @default(25)
  weekendStart DateTime
  weekendEnd   DateTime
  isPaid       Boolean  @default(false)
  isUsed       Boolean  @default(false)
  createdAt    DateTime @default(now())
}
